<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suggestions d'activités à Paris</title>
    <!-- Feuille de style Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Police Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome pour l'icône de panier -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
    /* Styles généraux */
    body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
    }

    h1 {
        color: #333;
        margin: 20px;
    }

    /* Conteneur principal */
    .layout-container {
        display: flex;
        flex-direction: row;
    }

    /* Section gauche */
    .left-section {
        width: 75%;
        overflow-y: auto;
        height: 100vh;
        padding: 20px;
        box-sizing: border-box;
    }

    /* Section droite (Carte) */
    .right-section {
        width: 25%;
        position: sticky;
        top: 0;
        height: 100vh;
        overflow: hidden;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    /* Filtres */
    #filters {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    #filters div {
        flex: 1 1 calc(50% - 20px);
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
    }

    #filters label {
        margin-bottom: 5px;
        text-align: center;
    }

    /* Réduction de la taille des sliders */
    #filters input[type="range"] {
        width: 80%;
        max-width: 200px;
    }

    /* Résultats */
    #results {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .activity-card {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
    }

    .activity-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
    }

    .activity-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .activity-content {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .activity-title {
        font-size: 1.5em;
        color: #333;
        margin-bottom: 10px;
        text-align: center;
    }

    .activity-description {
        font-size: 1em;
        color: #555;
        margin-bottom: 10px;
        text-align: center;
    }

    .activity-details {
        font-size: 0.9em;
        color: #777;
        margin-bottom: 10px;
        text-align: center;
    }

    .add-to-wishlist-btn {
        background-color: #D2691E; /* Couleur terracotta */
        color: white;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 5px;
        margin: 5px 0;
        width: 80%;
    }

    .more-info-btn {
        background-color: #007BFF;
        color: white;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 5px;
        margin: 5px 0;
        width: 80%;
    }

    /* Icône de la wishlist */
    #wishlist-icon {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #007BFF;
        color: white;
        padding: 10px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1001;
    }

    #wishlist-icon i {
        font-size: 1.5em;
    }

    #wishlist-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #ff6347;
        color: white;
        border-radius: 50%;
        padding: 2px 5px;
        font-size: 0.8em;
    }

    /* Fenêtre dépliante de la wishlist */
    #wishlist-drawer {
        position: fixed;
        right: -300px;
        top: 0;
        width: 300px;
        height: 100%;
        background-color: #fff;
        box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        transition: right 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
    }

    #wishlist-drawer.open {
        right: 0;
    }

    #wishlist-drawer h3 {
        padding: 20px;
        margin: 0;
        background-color: #007BFF;
        color: white;
    }

    #wishlist-items {
        padding: 20px;
    }

    .wishlist-item {
        background-color: #f2e0d4;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .wishlist-item p {
        margin: 0;
        font-size: 1em;
        font-weight: bold;
    }

    .remove-wishlist-btn {
        background-color: #ff6347;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 5px;
    }

    /* Carte d'activité ajoutée à la wishlist */
    .activity-card.wishlist-added {
        background-color: #f2e0d4;
        border: 1px solid #c15a37;
    }

    /* Styles pour la pop-up */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: none;
        z-index: 1000;
    }

    .popup-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        width: 80%;
        max-width: 800px;
        height: 80%;
        overflow-y: auto;
        border-radius: 10px;
        display: none;
        z-index: 1001;
        padding: 20px;
    }

    .close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 2em;
        color: #333;
        cursor: pointer;
    }

    .activity-hearts {
    font-size: 1.2em;
    margin: 5px 0;
    }

    /* Styles pour les appareils mobiles */
    @media screen and (max-width: 768px) {
        /* Réinitialisation des marges du body et du html */
        body, html {
            margin: 0;
            padding: 0;
        }

        /* Ajustement du titre */
        h1 {
            margin: 5px 0 0 0;
            text-align: center;
            font-size: 1.5em;
        }

        .layout-container {
            flex-direction: column;
            margin-top: 0;
        }

        .left-section {
            width: 100%;
            height: auto;
            padding: 10px;
            margin-top: 135px;
        }

        .right-section {
            width: 100%;
            height: 200px;
            position: fixed;
            top: 0;
            left: 0;
        }

        #map {
            height: 190px;
        }

        /* Positionnement de l'icône de la wishlist en haut à droite */
        #wishlist-icon {
            top: 10px;
            right: 10px;
            z-index: 1001;
        }

        /* Ajustement des filtres */
        #filters {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 5px;
            margin-top: 5px;
        }

        #filters div {
            flex: 1 1 calc(50% - 10px);
            max-width: calc(50% - 10px);
            margin-bottom: 5px; /* Réduction de l'espace entre les lignes */
            align-items: center;
        }

        #filters label {
            font-size: 0.9em;
        }

        /* Réduction de la taille des sliders en version mobile */
        #filters input[type="range"] {
            width: 100%;
            max-width: 100%;
        }

        /* Résultats */
        #results {
            grid-template-columns: 1fr;
            padding: 10px;
        }

        .activity-card {
            margin-bottom: 20px;
        }
    }
</style>
</head>
<body>
    <!-- Titre -->
    <h1>Suggestions d'activités à Paris</h1>

    <!-- Icône de la wishlist -->
    <div id="wishlist-icon" onclick="toggleWishlist()">
        <i class="fas fa-shopping-cart"></i>
        <span id="wishlist-count">0</span>
    </div>

    <!-- Fenêtre dépliante de la wishlist -->
    <div id="wishlist-drawer">
        <h3>Wishlist</h3>
        <div id="wishlist-items">
            <!-- Les éléments de la wishlist seront insérés ici -->
        </div>
    </div>

    <!-- Conteneur principal -->
    <div class="layout-container">
        <!-- Section gauche -->
        <div class="left-section">
            <!-- Filtres -->
            <div id="filters">
                <div>
                    <label for="touristique">Touristique (1 à 5): <span id="touristique_value">3</span></label>
                    <input type="range" id="touristique" name="touristique" min="1" max="5" value="3" oninput="updateCriteria()">
                </div>
                <div>
                    <label for="culturel">Culturel (1 à 5): <span id="culturel_value">3</span></label>
                    <input type="range" id="culturel" name="culturel" min="1" max="5" value="3" oninput="updateCriteria()">
                </div>
                <div>
                    <label for="chill">Chill (1 à 5): <span id="chill_value">3</span></label>
                    <input type="range" id="chill" name="chill" min="1" max="5" value="3" oninput="updateCriteria()">
                </div>
                <div>
                    <label for="popularity">Popularité (1 à 5): <span id="popularity_value">5</span></label>
                    <input type="range" id="popularity" name="popularity" min="1" max="5" value="5" oninput="updateCriteria()">
                </div>

                <!-- New filter for hearts -->
                <div>
                    <label for="hearts">Nombre minimum de coeurs:</label>
                    <select id="hearts" name="hearts" onchange="updateCriteria()">
                        <option value="1">>= 1 coeur</option>
                        <option value="2">>= 2 coeurs</option>
                        <option value="3">>= 3 coeurs</option>
                        <option value="4">>= 4 coeurs</option>
                    </select>
                </div>

                <!-- New checkbox for UNESCO filter -->
                <div>
                    <label for="unesco">Filtrer uniquement le patrimoine UNESCO:</label>
                    <input type="checkbox" id="unesco" name="unesco" onchange="updateCriteria()">
                </div>
            </div>

            <!-- Résultats -->
            <div id="results">
                <!-- Les activités seront insérées ici dynamiquement -->
            </div>
        </div>

        <!-- Section droite (Carte) -->
        <div class="right-section">
            <div id="map"></div>
        </div>
    </div>

    <!-- Pop-up pour afficher les détails du site touristique -->
    <div id="popup-overlay" class="popup-overlay" onclick="closePopup()"></div>
    <div id="popup-content" class="popup-content">
        <span class="close-btn" onclick="closePopup()">&times;</span>
        <div id="popup-inner-content">
            <!-- Le contenu détaillé sera chargé ici -->
        </div>
    </div>

    <!-- Script Leaflet -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Votre script JavaScript -->
    <script>
        const wishlistMarkers = {};
        const wishlistItems = {};

        // Initialiser la carte
        const map = L.map('map').setView([48.8566, 2.3522], 12);

        const terracottaIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [0, -41]
        });

        // Récupérer la clé API depuis Flask
        fetch('/api/key')
            .then(response => response.json())
            .then(data => {
                L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${data.apiKey}`, {
                    attribution: 'Map data &copy; OpenStreetMap contributors, Imagery © Mapbox',
                    maxZoom: 18,
                    tileSize: 512,
                    zoomOffset: -1
                }).addTo(map);
            })
            .catch(error => {
                console.error('Erreur lors de la récupération de la clé API :', error);
            });

        let currentMarker = null;

        // Fonction pour afficher la popup sur la carte sans ajouter de marqueur
        function showOnMap(latitude, longitude, name) {
            // Supprimer le marqueur actuel s'il existe
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // Centrer la carte sur l'emplacement cliqué et ouvrir une popup
            map.setView([latitude, longitude], 12);

            // Ouvrir une popup aux coordonnées spécifiées avec le nom
            L.popup()
                .setLatLng([latitude, longitude])
                .setContent(`<strong>${name}</strong>`)
                .openOn(map);
        }

        function displayActivities(activities) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';

            activities.forEach(activity => {
                const slug = generateSlug(activity.name);
                const card = document.createElement('div');
                card.className = 'activity-card';

                // Ouvrir le détail de l'activité au clic
                card.onclick = () => showOnMap(activity.latitude, activity.longitude, activity.name);

                const buttonText = wishlistItems[activity.name] ? "Retirer de la wishlist" : "Ajouter à la wishlist";

                // Check if affinity_score exists or set it to 'Non disponible'
                const affinityScore = activity.affinity_score !== null && activity.affinity_score !== undefined
                    ? `${activity.affinity_score}/100`
                    : 'Non disponible';

                // Add logic for must_do_score to display hearts
                let hearts = '';
                if (activity.must_do_score >= 95) {
                    hearts = '❤️‍🔥❤️‍🔥❤️‍🔥❤️‍🔥';
                } else if (activity.must_do_score >= 85) {
                    hearts = '❤️‍🔥❤️‍🔥❤️‍🔥';
                } else if (activity.must_do_score >= 75) {
                    hearts = '❤️‍🔥❤️‍🔥';
                } else {
                    hearts = '🤍';
                }

                // Add UNESCO icon 🏛️ with a tooltip if it belongs to UNESCO heritage
                const unescoIcon = activity.unesco ? `<span class="unesco-icon" title="Ce site fait partie du patrimoine mondial de l'UNESCO en raison de son importance historique et culturelle, englobant des monuments emblématiques et des quartiers historiques de Paris.">🏛️</span>` : '';

                // Insert the hearts and unescoIcon under the title
                card.innerHTML = `
                    <img src="${activity.image_url}" alt="${activity.name}" class="activity-image">
                    <div class="activity-content">
                        <h3 class="activity-title">${activity.name}</h3>
                        <div class="activity-hearts">${hearts} ${unescoIcon}</div> <!-- Display the hearts and UNESCO icon with tooltip here -->
                        <p class="activity-description">${activity.description}</p>
                        <div class="activity-details">
                            <p>🌟 Score de matching: ${affinityScore}</p>
                            <p>🏙️ Touristique: ${activity.touristic_score}/100</p>
                            <p>🎨 Culturel: ${activity.cultural_score}/100</p>
                            <p>😌 Chill: ${activity.chill_score}/100</p>
                            <p>📸 Popularité: ${activity.popularity_score}/100</p>
                        </div>
                        <button class="add-to-wishlist-btn" onclick="toggleWishlistItem(${activity.latitude}, ${activity.longitude}, '${activity.name}', this); event.stopPropagation();">${buttonText}</button>
                        <!-- Bouton "En savoir plus" -->
                        <button class="more-info-btn" onclick="openPopup('${slug}'); event.stopPropagation();">En savoir plus</button>
                    </div>
                `;
                if (wishlistItems[activity.name]) {
                    card.classList.add('wishlist-added');
                }
                resultsContainer.appendChild(card);
            });
        }

        // Fonction pour basculer un élément dans la wishlist
        function toggleWishlistItem(lat, lon, name, button) {
            if (wishlistItems[name]) {
                removeFromWishlist(name, lat, lon, button);
            } else {
                addToWishlist(lat, lon, name, button);
            }
        }

        // Fonction pour ajouter une activité à la wishlist
        function addToWishlist(lat, lon, name, button) {
            // Mettre à jour le texte du bouton
            button.textContent = "Retirer de la wishlist";

            // Ajouter l'activité à wishlistItems
            wishlistItems[name] = true;

            // Ajouter l'élément à la wishlist
            const wishlistBlock = document.getElementById('wishlist-items');

            // Créer l'élément wishlist-item
            const wishlistItem = document.createElement('div');
            wishlistItem.className = 'wishlist-item';
            wishlistItem.setAttribute('data-name', name);
            wishlistItem.innerHTML = `
                <p>${name}</p>
                <button class="remove-wishlist-btn" onclick="removeFromWishlist('${name}', ${lat}, ${lon}, this); event.stopPropagation();">Supprimer</button>
            `;

            // Ajouter l'élément à la wishlist
            wishlistBlock.appendChild(wishlistItem);

            // Ajouter le marqueur sur la carte
            const marker = L.marker([lat, lon], { icon: terracottaIcon })
                .addTo(map)
                .bindPopup(`
                    📍 <strong>${name}</strong><br>
                    <button onclick="removeFromWishlist('${name}', ${lat}, ${lon});">Supprimer de la liste</button>
                `);
            wishlistMarkers[name] = marker;

            // Mettre à jour le compteur de la wishlist
            updateWishlistCount();

            // Ajouter la classe wishlist-added à la carte d'activité
            const card = button.closest('.activity-card');
            card.classList.add('wishlist-added');
        }

        // Fonction pour supprimer une activité de la wishlist
        function removeFromWishlist(name, lat, lon, button) {
            // Mettre à jour le texte du bouton sur la carte d'activité
            const activityCards = document.querySelectorAll('.activity-card');
            activityCards.forEach(card => {
                if (card.querySelector('.activity-title').textContent === name) {
                    const btn = card.querySelector('.add-to-wishlist-btn');
                    btn.textContent = "Ajouter à la wishlist";
                    card.classList.remove('wishlist-added');
                }
            });

            // Supprimer l'activité de wishlistItems
            delete wishlistItems[name];

            // Supprimer l'élément de la wishlist
            const wishlistBlock = document.getElementById('wishlist-items');
            const items = wishlistBlock.getElementsByClassName('wishlist-item');
            for (let i = items.length - 1; i >= 0; i--) {
                if (items[i].getAttribute('data-name') === name) {
                    wishlistBlock.removeChild(items[i]);
                }
            }

            // Supprimer le marqueur de la carte
            if (wishlistMarkers[name]) {
                map.removeLayer(wishlistMarkers[name]);
                delete wishlistMarkers[name];
            }

            // Mettre à jour le compteur de la wishlist
            updateWishlistCount();
        }

        // Fonction pour basculer l'affichage de la wishlist
        function toggleWishlist() {
            const wishlistDrawer = document.getElementById('wishlist-drawer');
            wishlistDrawer.classList.toggle('open');
        }

        // Fonction pour mettre à jour le compteur de la wishlist
        function updateWishlistCount() {
            const count = Object.keys(wishlistItems).length;
            document.getElementById('wishlist-count').innerText = count;
        }

        // Fonction pour récupérer et afficher les activités depuis le serveur
        function updateCriteria() {
            const touristique = document.getElementById('culturel').value;
            const culturel = document.getElementById('culturel').value;
            const chill = document.getElementById('chill').value;
            const popularity = document.getElementById('popularity').value;
            const hearts = document.getElementById('hearts').value; // Get the selected number of hearts
            const unescoOnly = document.getElementById('unesco').checked; // Check if UNESCO filter is enabled

            document.getElementById('touristique_value').innerText = touristique;
            document.getElementById('culturel_value').innerText = culturel;
            document.getElementById('chill_value').innerText = chill;
            document.getElementById('popularity_value').innerText = popularity;

            fetch('/update_activities', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ touristique, culturel, chill, popularity, hearts, unescoOnly })
            })
            .then(response => response.json())
            .then(data => {
                displayActivities(data.activities);
            })
            .catch(error => console.error('Error:', error));
        }
        updateCriteria();

        // Fonction pour ouvrir la pop-up et charger le contenu
        function openPopup(slug) {
            event.stopPropagation();
            // Afficher les éléments de la pop-up
            document.getElementById('popup-overlay').style.display = 'block';
            document.getElementById('popup-content').style.display = 'block';

            // Charger le contenu correspondant
            fetch(`/site/${slug}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('popup-inner-content').innerHTML = data;
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du contenu :', error);
                    document.getElementById('popup-inner-content').innerHTML = '<p>Une erreur est survenue lors du chargement du contenu.</p>';
                });
        }

        // Fonction pour fermer la pop-up
        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
            document.getElementById('popup-content').style.display = 'none';
            document.getElementById('popup-inner-content').innerHTML = '';
        }

        function generateSlug(name) {
            return name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9 ]/g, '')
                    .trim().replace(/\s+/g, '-');
        }
    </script>
</body>
</html>