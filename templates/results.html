<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suggestions d'activit√©s √† Paris</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for the wishlist icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* General Styles */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        h1 {
            color: #333;
            margin: 20px;
        }

        /* Layout Container */
        .layout-container {
            display: flex;
            flex-direction: row;
        }

        /* Left Section */
        .left-section {
            width: 75%;
            overflow-y: auto;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Right Section (Map) */
        .right-section {
            width: 25%;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Filters */
        #filters {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        #filters div {
            flex: 1 1 calc(50% - 20px);
            display: flex;
            flex-direction: column;
        }

        #filters label {
            margin-bottom: 5px;
        }

        /* Results */
        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .activity-card {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .activity-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }

        .activity-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .activity-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .activity-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .activity-description {
            font-size: 1em;
            color: #555;
            margin-bottom: 10px;
        }

        .activity-details {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 10px;
        }

        .add-to-wishlist-btn {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
        }

        /* Wishlist Icon */
        #wishlist-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #007BFF;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
        }

        #wishlist-icon i {
            font-size: 1.5em;
        }

        #wishlist-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff6347;
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            font-size: 0.8em;
        }

        /* Wishlist Drawer */
        #wishlist-drawer {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: #fff;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }

        #wishlist-drawer.open {
            right: 0;
        }

        #wishlist-drawer h3 {
            padding: 20px;
            margin: 0;
            background-color: #007BFF;
            color: white;
        }

        #wishlist-items {
            padding: 20px;
        }

        .wishlist-item {
            background-color: #f2e0d4;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wishlist-item p {
            margin: 0;
            font-size: 1em;
            font-weight: bold;
        }

        .remove-wishlist-btn {
            background-color: #ff6347;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        /* Activity Card when added to wishlist */
        .activity-card.wishlist-added {
            background-color: #f2e0d4;
            border: 1px solid #c15a37;
        }

        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            z-index: 1000;
        }

        .popup-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            width: 80%;
            max-width: 800px;
            height: 80%;
            overflow-y: auto;
            border-radius: 10px;
            display: none;
            z-index: 1001;
            padding: 20px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            color: #333;
            cursor: pointer;
        }

        /* Mobile Styles */
        @media screen and (max-width: 768px) {
            .layout-container {
                flex-direction: column;
            }

            .left-section {
                width: 100%;
                height: auto;
                padding: 10px;
            }

            .right-section {
                width: 100%;
                height: 200px;
                position: fixed;
                top: 0;
                left: 0;
            }

            #map {
                height: 200px;
            }

            .left-section {
                margin-top: 220px; /* To avoid overlapping with the fixed map */
            }

            #filters {
                flex-direction: column;
                align-items: center;
            }

            #filters div {
                flex: none;
                width: 100%;
                max-width: 300px;
            }

            #wishlist-icon {
                top: 230px; /* Adjust position below the map */
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Title -->
    <h1>Suggestions d'activit√©s √† Paris</h1>

    <!-- Wishlist Icon -->
    <div id="wishlist-icon" onclick="toggleWishlist()">
        <i class="fas fa-shopping-cart"></i>
        <span id="wishlist-count">0</span>
    </div>

    <!-- Wishlist Drawer -->
    <div id="wishlist-drawer">
        <h3>Wishlist</h3>
        <div id="wishlist-items">
            <!-- Wishlist items will be dynamically inserted here -->
        </div>
    </div>

    <!-- Layout Container -->
    <div class="layout-container">
        <!-- Left Section -->
        <div class="left-section">
            <!-- Filters -->
            <div id="filters">
                <div>
                    <label for="touristique">Touristique (1 √† 5): <span id="touristique_value">3</span></label>
                    <input type="range" id="touristique" name="touristique" min="1" max="5" value="3" oninput="updateCriteria()">
                </div>
                <div>
                    <label for="culturel">Culturel (1 √† 5): <span id="culturel_value">3</span></label>
                    <input type="range" id="culturel" name="culturel" min="1" max="5" value="3" oninput="updateCriteria()">
                </div>
                <div>
                    <label for="chill">Chill (1 √† 5): <span id="chill_value">3</span></label>
                    <input type="range" id="chill" name="chill" min="1" max="5" value="3" oninput="updateCriteria()">
                </div>
                <div>
                    <label for="popularity">Popularit√© (1 √† 5): <span id="popularity_value">5</span></label>
                    <input type="range" id="popularity" name="popularity" min="1" max="5" value="5" oninput="updateCriteria()">
                </div>
            </div>

            <!-- Results -->
            <div id="results">
                <!-- Activities will be dynamically inserted here -->
            </div>
        </div>

        <!-- Right Section (Map) -->
        <div class="right-section">
            <div id="map"></div>
        </div>
    </div>

    <!-- Popup for activity details -->
    <div id="popup-overlay" class="popup-overlay" onclick="closePopup()"></div>
    <div id="popup-content" class="popup-content">
        <span class="close-btn" onclick="closePopup()">&times;</span>
        <div id="popup-inner-content">
            <!-- Detailed content will be loaded here -->
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Your JavaScript code -->
    <script>
        const wishlistMarkers = {};
        const wishlistItems = {};

        // Initialize the map
        const map = L.map('map').setView([48.8566, 2.3522], 12);

        const terracottaIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [0, -41]
        });

        // Fetch the API key from Flask
        fetch('/api/key')
            .then(response => response.json())
            .then(data => {
                L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${data.apiKey}`, {
                    attribution: 'Map data &copy; OpenStreetMap contributors, Imagery ¬© Mapbox',
                    maxZoom: 18,
                    tileSize: 512,
                    zoomOffset: -1
                }).addTo(map);
            })
            .catch(error => {
                console.error('Erreur lors de la r√©cup√©ration de la cl√© API :', error);
            });

        let currentMarker = null;

        // Function to show the popup on the map without adding a marker
        function showOnMap(latitude, longitude, name) {
            // Remove the current marker if one exists
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // Center the map on the clicked location and open a popup
            map.setView([latitude, longitude], 12);

            // Open a popup at the specified coordinates with the name
            L.popup()
                .setLatLng([latitude, longitude])
                .setContent(`<strong>${name}</strong>`)
                .openOn(map);
        }

        // Function to update activities and display them
        function displayActivities(activities) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';

            activities.forEach(activity => {
                const slug = generateSlug(activity.name);
                const card = document.createElement('div');
                card.className = 'activity-card';

                // Open the map popup on click
                card.onclick = () => showOnMap(activity.latitude, activity.longitude, activity.name);

                const buttonText = wishlistItems[activity.name] ? "Retirer de la wishlist" : "Ajouter √† la wishlist";

                card.innerHTML = `
                    <img src="${activity.image_url}" alt="${activity.name}" class="activity-image">
                    <div class="activity-content">
                        <h3 class="activity-title">${activity.name}</h3>
                        <p class="activity-description">${activity.description}</p>
                        <div class="activity-details">
                            <p>üåü Score de matching: ${activity.affinity_score || 'Non disponible'}/100</p>
                            <p>üèôÔ∏è Touristique: ${activity.touristic_score}/10</p>
                            <p>üé® Culturel: ${activity.cultural_score}/10</p>
                            <p>üòå Chill: ${activity.chill_score}/10</p>
                            <p>üì∏ Popularit√©: ${activity.popularity_score}/10</p>
                        </div>
                        <button class="add-to-wishlist-btn" onclick="toggleWishlistItem(${activity.latitude}, ${activity.longitude}, '${activity.name}', this); event.stopPropagation();">${buttonText}</button>
                        <!-- More Info Button -->
                        <button class="more-info-btn" onclick="openPopup('${slug}'); event.stopPropagation();">En savoir plus</button>
                    </div>
                `;
                if (wishlistItems[activity.name]) {
                    card.classList.add('wishlist-added');
                }
                resultsContainer.appendChild(card);
            });
        }

        // Function to toggle an activity in the wishlist
        function toggleWishlistItem(lat, lon, name, button) {
            if (wishlistItems[name]) {
                removeFromWishlist(name, lat, lon, button);
            } else {
                addToWishlist(lat, lon, name, button);
            }
        }

        // Function to add activity to wishlist
        function addToWishlist(lat, lon, name, button) {
            // Update the button text
            button.textContent = "Retirer de la wishlist";

            // Add the activity to wishlistItems
            wishlistItems[name] = true;

            // Add the item to the wishlist
            const wishlistBlock = document.getElementById('wishlist-items');

            // Create the wishlist item element
            const wishlistItem = document.createElement('div');
            wishlistItem.className = 'wishlist-item';
            wishlistItem.setAttribute('data-name', name);
            wishlistItem.innerHTML = `
                <p>${name}</p>
                <button class="remove-wishlist-btn" onclick="removeFromWishlist('${name}', ${lat}, ${lon}, this); event.stopPropagation();">Supprimer</button>
            `;

            // Add the item to the wishlist
            wishlistBlock.appendChild(wishlistItem);

            // Add the marker to the map
            const marker = L.marker([lat, lon], { icon: terracottaIcon })
                .addTo(map)
                .bindPopup(`
                    üìç <strong>${name}</strong><br>
                    <button onclick="removeFromWishlist('${name}', ${lat}, ${lon});">Supprimer de la liste</button>
                `);
            wishlistMarkers[name] = marker;

            // Update the wishlist count
            updateWishlistCount();

            // Add the wishlist-added class to the activity card
            const card = button.closest('.activity-card');
            card.classList.add('wishlist-added');
        }

        // Function to remove activity from wishlist
        function removeFromWishlist(name, lat, lon, button) {
            // Update the button text on the activity card
            const activityCards = document.querySelectorAll('.activity-card');
            activityCards.forEach(card => {
                if (card.querySelector('.activity-title').textContent === name) {
                    const btn = card.querySelector('.add-to-wishlist-btn');
                    btn.textContent = "Ajouter √† la wishlist";
                    card.classList.remove('wishlist-added');
                }
            });

            // Remove the activity from wishlistItems
            delete wishlistItems[name];

            // Remove the item from the wishlist
            const wishlistBlock = document.getElementById('wishlist-items');
            const items = wishlistBlock.getElementsByClassName('wishlist-item');
            for (let i = items.length - 1; i >= 0; i--) {
                if (items[i].getAttribute('data-name') === name) {
                    wishlistBlock.removeChild(items[i]);
                }
            }

            // Remove the marker from the map
            if (wishlistMarkers[name]) {
                map.removeLayer(wishlistMarkers[name]);
                delete wishlistMarkers[name];
            }

            // Update the wishlist count
            updateWishlistCount();
        }

        // Function to toggle the wishlist drawer
        function toggleWishlist() {
            const wishlistDrawer = document.getElementById('wishlist-drawer');
            wishlistDrawer.classList.toggle('open');
        }

        // Function to update the wishlist count
        function updateWishlistCount() {
            const count = Object.keys(wishlistItems).length;
            document.getElementById('wishlist-count').innerText = count;
        }

        // Function to fetch and display activities from the server
        function updateCriteria() {
            const touristique = document.getElementById('touristique').value;
            const culturel = document.getElementById('culturel').value;
            const chill = document.getElementById('chill').value;
            const popularity = document.getElementById('popularity').value;

            document.getElementById('touristique_value').innerText = touristique;
            document.getElementById('culturel_value').innerText = culturel;
            document.getElementById('chill_value').innerText = chill;
            document.getElementById('popularity_value').innerText = popularity;

            fetch('/update_activities', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ touristique, culturel, chill, popularity })
            })
            .then(response => response.json())
            .then(data => {
                displayActivities(data.activities);
            })
            .catch(error => console.error('Error:', error));
        }

        updateCriteria();

        // Function to open the popup and load content
        function openPopup(slug) {
            event.stopPropagation();
            // Show the popup elements
            document.getElementById('popup-overlay').style.display = 'block';
            document.getElementById('popup-content').style.display = 'block';

            // Load the corresponding content
            fetch(`/site/${slug}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('popup-inner-content').innerHTML = data;
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du contenu :', error);
                    document.getElementById('popup-inner-content').innerHTML = '<p>Une erreur est survenue lors du chargement du contenu.</p>';
                });
        }

        // Function to close the popup
        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
            document.getElementById('popup-content').style.display = 'none';
            document.getElementById('popup-inner-content').innerHTML = '';
        }

        function generateSlug(name) {
            return name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9 ]/g, '')
                    .trim().replace(/\s+/g, '-');
        }
    </script>
</body>
</html>