<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suggestions d'activités à Paris</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Default styles for larger screens (desktop view) */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        h1 {
            color: #333;
            text-align: left;
            margin-bottom: 20px;
        }

        .layout-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: nowrap;
        }

        .left-section {
            width: 60%;
            display: flex;
            flex-direction: column;
        }

        .right-section {
            width: 35%;
            position: sticky;
            top: 20px;
            height: 100vh;
        }

        #filters {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 20px;
        }

        #filters div {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .activity-card {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .activity-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }

        .activity-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .activity-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .activity-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .activity-description {
            font-size: 1em;
            color: #555;
            margin-bottom: 10px;
        }

        .activity-details {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 10px;
        }

        .affinity-score {
            font-size: 1.2em;
            color: #007BFF;
            margin-top: 10px;
        }

        #map {
            width: 100%;
            height: 70vh;
        }

        /* Wishlist block styles */
        .wishlist-block {
            background-color: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .wishlist-item {
            background-color: #f2e0d4;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wishlist-item p {
            margin: 0;
            font-size: 1em;
            font-weight: bold;
        }

        .remove-wishlist-btn {
            background-color: #ff6347;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .activity-card.wishlist-added {
            background-color: #f2e0d4;
            border: 1px solid #c15a37;
        }

        .add-to-wishlist-btn {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
        }

        @media screen and (max-width: 768px) {
            body, html {
                margin: 0;
                padding: 0;
                overflow-x: hidden;
            }

            h1 {
                font-size: 1.2em;
                text-align: left; /* Aligner le titre à gauche */
                margin: 10px 0;
                padding: 10px;
                background-color: #f0f0f0;
                color: #333;
                z-index: 20;
                width: 60%; /* Assurez-vous que le titre n'occupe que la largeur de la section gauche */
                margin-right: 40%; /* Ajouter une marge droite pour éviter le chevauchement avec la section droite */
            }

            .layout-container {
                display: flex;
                flex-direction: row; /* Garder les sections côte à côte */
                align-items: flex-start;
                padding: 0;
            }

            .left-section {
                width: 60%; /* Ajuster la largeur selon vos besoins */
                margin-top: 0; /* Supprimer la marge supérieure */
                overflow-y: auto; /* Permettre le défilement des activités */
                padding-right: 10px; /* Espace entre les sections */
                margin-right: 0; /* Supprimer la marge droite */
            }

            .right-section {
                width: 40%; /* Ajuster la largeur selon vos besoins */
                position: fixed;
                right: 0;
                top: 0;
                height: 100vh; /* Occuper toute la hauteur de la fenêtre */
                z-index: 10;
                background-color: #fff;
                display: flex;
                flex-direction: column;
                overflow: hidden; /* Empêcher le débordement */
            }

            /* Ajuster la section gauche pour éviter que le contenu ne soit caché sous la section fixe */
            .left-section {
                margin-right: 40%; /* Correspond à la largeur de .right-section */
            }

            /* Ajustements pour les sliders dans la section des filtres */
            #filters {
                display: flex;
                flex-direction: column; /* Empiler les sliders verticalement */
                align-items: flex-start; /* Aligner les sliders à gauche */
                gap: 10px;
                padding: 10px;
            }

            #results {
                grid-template-columns: 1fr;
                padding: 10px;
            }

            .activity-card {
                margin-bottom: 20px;
            }

            #map {
                width: 100%;
                height: 60%; /* Ajuster la hauteur de la carte selon vos besoins */
            }

            .wishlist-block {
                width: 100%;
                height: 40%; /* Le reste de l'espace pour la wishlist */
                overflow-y: auto; /* Permettre le défilement si la wishlist est longue */
            }
        }

        /* Styles pour la pop-up */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none; /* Masqué par défaut */
            z-index: 1000;
        }

        .popup-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            width: 80%;
            max-width: 800px;
            height: 80%;
            overflow-y: auto;
            border-radius: 10px;
            display: none; /* Masqué par défaut */
            z-index: 1001;
            padding: 20px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            color: #333;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Title -->
    <h1>Suggestions d'activités à Paris</h1>

    <!-- Map and Wishlist -->
    <div class="layout-container">
        <!-- Left column with filters and results -->
        <div class="left-section">
        <div id="filters">
            <div>
                <label for="touristique">Touristique (1 à 5): <span id="touristique_value">3</span></label>
                <input type="range" id="touristique" name="touristique" min="1" max="5" value="3" oninput="updateCriteria()">
            </div>
            <div>
                <label for="culturel">Culturel (1 à 5): <span id="culturel_value">3</span></label>
                <input type="range" id="culturel" name="culturel" min="1" max="5" value="3" oninput="updateCriteria()">
            </div>
            <div>
                <label for="chill">Chill (1 à 5): <span id="chill_value">3</span></label>
                <input type="range" id="chill" name="chill" min="1" max="5" value="3" oninput="updateCriteria()">
            </div>
            <div>
                <label for="popularity">Popularité (1 à 5): <span id="popularity_value">5</span></label>
                <input type="range" id="popularity" name="popularity" min="1" max="5" value="5" oninput="updateCriteria()">
            </div>
        </div>

            <div id="results">
                <!-- Activities will be dynamically inserted here -->
            </div>
        </div>

        <!-- Right column with the map -->
        <div class="right-section">
            <div id="map"></div>

            <!-- Wishlist Block Positioned Just Below the Map -->
            <div class="wishlist-block" id="wishlist-block">
                <h3>Wishlist</h3>
                <div id="wishlist-items">
                    <!-- Wishlist items will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>
        <!-- Pop-up pour afficher les détails du site touristique -->
    <div id="popup-overlay" class="popup-overlay" onclick="closePopup()"></div>
    <div id="popup-content" class="popup-content">
        <span class="close-btn" onclick="closePopup()">&times;</span>
        <div id="popup-inner-content">
            <!-- Le contenu détaillé sera chargé ici -->
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const wishlistMarkers = {};
        const wishlistItems = {}; // Object to store wishlist items by name

        // Initialize the map
        const map = L.map('map').setView([48.8566, 2.3522], 12);

        const terracottaIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png', // Remplace cette URL par une image de pin terracotta si nécessaire
            iconSize: [25, 41], // Taille de l'icône
            iconAnchor: [12, 41], // Point d'ancrage de l'icône
            popupAnchor: [0, -41] // Ancre du popup
        });

        // Fetch the API key from Flask
        fetch('/api/key')
            .then(response => response.json())
            .then(data => {
                L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${data.apiKey}`, {
                    attribution: 'Map data &copy; OpenStreetMap contributors, Imagery © Mapbox',
                    maxZoom: 18,
                    tileSize: 512,
                    zoomOffset: -1
                }).addTo(map);
            })
            .catch(error => {
                console.error('Erreur lors de la récupération de la clé API :', error);
            });

        let currentMarker = null;

        // Function to show the popup on the map without adding a marker
        function showOnMap(latitude, longitude, name) {
            // Remove the current marker if one exists (this avoids superposition)
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // Center the map on the clicked location and open a popup (infobulle)
            map.setView([latitude, longitude], 12); // Adjust the zoom level as needed

            // Open a popup at the specified coordinates with the name
            L.popup()
                .setLatLng([latitude, longitude])
                .setContent(`<strong>${name}</strong>`)
                .openOn(map);
        }

        // Function to update activities and display them
        function displayActivities(activities) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = ''; 

            activities.forEach(activity => {
                const slug = generateSlug(activity.name);
                const card = document.createElement('div');
                card.className = 'activity-card';
                card.onclick = () => showOnMap(activity.latitude, activity.longitude, activity.name);
                
                const buttonText = wishlistItems[activity.name] ? "Retirer de la wishlist" : "Ajouter à la wishlist";
                
                card.innerHTML = `
                    <img src="${activity.image_url}" alt="${activity.name}" class="activity-image">
                    <div class="activity-content">
                        <h3 class="activity-title">${activity.name}</h3>
                        <p class="activity-description">${activity.description}</p>
                        <div class="activity-details">
                            <p>🌟 Score de matching: ${activity.affinity_score || 'Non disponible'}/100</p>
                            <p>🏙️ Touristique: ${activity.touristic_score}/10</p>
                            <p>🎨 Culturel: ${activity.cultural_score}/10</p>
                            <p>😌 Chill: ${activity.chill_score}/10</p>
                            <p>📸 Popularity: ${activity.popularity_score}/10</p>

                        </div>
                        <button class="add-to-wishlist-btn" onclick="toggleWishlist(${activity.latitude}, ${activity.longitude}, '${activity.name}', this)">${buttonText}</button>
                        <!-- Ajout du bouton "En savoir plus" -->
                        <button class="more-info-btn" onclick="openPopup('${slug}')">En savoir plus</button>

                    </div>
                `;
                resultsContainer.appendChild(card);
            });
        }

        // Function to toggle activity in wishlist
        function toggleWishlist(lat, lon, name, button) {
            if (wishlistItems[name]) {
                // If the item is in the wishlist, remove it
                removeFromWishlist(name, lat, lon, button);
            } else {
                // If the item is not in the wishlist, add it
                addToWishlist(lat, lon, name, button);
            }
        }

        // Function to add activity to wishlist
        function addToWishlist(lat, lon, name, button) {
            const wishlistBlock = document.getElementById('wishlist-items');
            const card = button.parentElement.parentElement;

            // Fermer l'infobulle active si elle est ouverte
            map.closePopup();

            card.classList.add('wishlist-added');
            button.textContent = "Retirer de la wishlist";

            const wishlistItem = document.createElement('div');
            wishlistItem.className = 'wishlist-item';
            wishlistItem.setAttribute('data-name', name); // Ajout de l'attribut data-name
            wishlistItem.innerHTML = `
                <p>${name}</p>
                <button class="remove-wishlist-btn" onclick="removeFromWishlist('${name}', ${lat}, ${lon}, this)">Supprimer</button>
            `;
            wishlistBlock.appendChild(wishlistItem);

            // Ajouter le marqueur sur la carte
            const marker = L.marker([lat, lon], { icon: terracottaIcon }) // Utilisez l'icône terracotta ici
                .addTo(map)
                .bindPopup(`
                    📍 <strong>${name}</strong><br>
                    <button onclick="removeFromWishlist('${name}', ${lat}, ${lon})">Supprimer de la liste</button>
                `);
            wishlistMarkers[name] = marker;
            wishlistItems[name] = true;
        }

        // Fonction pour supprimer un élément de la wishlist
        function removeFromWishlist(name, lat, lon, button) {
            // Supprimer le marqueur de la carte
            if (wishlistMarkers[name]) {
                map.removeLayer(wishlistMarkers[name]);
                delete wishlistMarkers[name];
            }
            // Supprimer l'élément de la liste des items de la wishlist
            delete wishlistItems[name];

            // Supprimer l'élément du bloc wishlist
            const wishlistBlock = document.getElementById('wishlist-items');
            const items = wishlistBlock.getElementsByClassName('wishlist-item');
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];
                if (item.getAttribute('data-name') === name) {
                    wishlistBlock.removeChild(item);
                }
            }

            // Mettre à jour le bouton sur la carte d'activité
            document.querySelectorAll('.activity-card').forEach(card => {
                if (card.querySelector('.activity-title').textContent === name) {
                    card.classList.remove('wishlist-added');
                    const btn = card.querySelector('.add-to-wishlist-btn');
                    btn.textContent = "Ajouter à la wishlist";
                }
            });
        }

        // Function to fetch and display real activities from the server
        function updateCriteria() {
            const touristique = document.getElementById('touristique').value;
            const culturel = document.getElementById('culturel').value;
            const chill = document.getElementById('chill').value;
            const popularity = document.getElementById('popularity').value;


            document.getElementById('touristique_value').innerText = touristique;
            document.getElementById('culturel_value').innerText = culturel;
            document.getElementById('chill_value').innerText = chill;
            document.getElementById('popularity_value').innerText = popularity;

            fetch('/update_activities', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ touristique, culturel, chill, popularity })
            })
            .then(response => response.json())
            .then(data => {
                displayActivities(data.activities);
            })
            .catch(error => console.error('Error:', error));
        }

        updateCriteria();

        // Fonction pour ouvrir la pop-up et charger le contenu
        function openPopup(slug) {
            // Afficher les éléments de la pop-up
            document.getElementById('popup-overlay').style.display = 'block';
            document.getElementById('popup-content').style.display = 'block';

            // Charger le contenu de 'site_detail.html' correspondant
            fetch(`/site/${slug}`)
                .then(response => response.text())
                .then(data => {
                    // Insérer le contenu dans la pop-up
                    document.getElementById('popup-inner-content').innerHTML = data;
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du contenu :', error);
                    document.getElementById('popup-inner-content').innerHTML = '<p>Une erreur est survenue lors du chargement du contenu.</p>';
                });
        }

        // Fonction pour fermer la pop-up
        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
            document.getElementById('popup-content').style.display = 'none';
            document.getElementById('popup-inner-content').innerHTML = ''; // Nettoyer le contenu
        }

        function generateSlug(name) {
            return name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Supprime les accents
                    .replace(/[^a-z0-9 ]/g, '') // Supprime les caractères spéciaux
                    .trim().replace(/\s+/g, '-'); // Remplace les espaces par des tirets
        }
    </script>
</body>
</html>